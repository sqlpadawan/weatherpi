<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Sensor Dashboard</title>
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/chartjs-adapter-date-fns"></script>
  <style>
    body { font-family: sans-serif; margin: 2em; }
    .section { margin-bottom: 3em; }
    canvas { max-width: 100%; height: 400px; }
    #status { font-size: 0.9em; color: gray; margin-bottom: 1em; }
  </style>
</head>
<body>
  <h1>üå°Ô∏è Sensor Dashboard</h1>
  <div id="status">Initializing...</div>

  <div class="section">
    <h2>Last Hour</h2>
    <canvas id="chartHour"></canvas>
  </div>

  <div class="section">
    <h2>Last 7 Days</h2>
    <canvas id="chart7d"></canvas>
  </div>

  <div class="section">
    <h2>Thermometer</h2>
    <canvas id="thermoCanvas" width="100" height="400"></canvas>
  </div>

  <script>
    const chartHour = new Chart(document.getElementById("chartHour"), {
      type: "line",
      data: {
        labels: [],
        datasets: [{
          label: "Temperature (¬∞F)",
          data: [],
          borderColor: "#0077cc",
          backgroundColor: "rgba(0,119,204,0.2)",
          fill: true,
          tension: 0.3
        }]
      },
      options: {
        scales: {
          x: {
            type: "time",
            time: { unit: "minute" },
            title: { display: true, text: "Time (UTC)" }
          },
          y: {
            title: { display: true, text: "Temperature (¬∞F)" },
            min: -10,
            max: 110
          }
        },
        plugins: {
          legend: { display: true },
          tooltip: { mode: "index", intersect: false }
        },
        responsive: true
      }
    });

    const chart7d = new Chart(document.getElementById("chart7d"), {
      type: "line",
      data: {
        labels: [],
        datasets: [{
          label: "Temperature (¬∞F)",
          data: [],
          borderColor: "#cc3300",
          backgroundColor: "rgba(204,51,0,0.2)",
          fill: true,
          tension: 0.3
        }]
      },
      options: {
        scales: {
          x: {
            type: "time",
            time: { unit: "day" },
            title: { display: true, text: "Date (UTC)" }
          },
          y: {
            title: { display: true, text: "Temperature (¬∞F)" },
            min: -10,
            max: 110
          }
        },
        plugins: {
          legend: { display: true },
          tooltip: { mode: "index", intersect: false }
        },
        responsive: true
      }
    });

    function drawThermometer(tempF) {
      const canvas = document.getElementById("thermoCanvas");
      const ctx = canvas.getContext("2d");
      ctx.clearRect(0, 0, canvas.width, canvas.height);

      const x = canvas.width / 2;
      const tubeWidth = 20;
      const tubeHeight = 300;
      const tubeTop = 50;
      const bulbRadius = 15;

      // Draw tube
      ctx.strokeStyle = "#333";
      ctx.lineWidth = 2;
      ctx.strokeRect(x - tubeWidth / 2, tubeTop, tubeWidth, tubeHeight);

      // Draw bulb
      ctx.beginPath();
      ctx.arc(x, tubeTop + tubeHeight + bulbRadius / 2, bulbRadius, 0, Math.PI * 2);
      ctx.fillStyle = "#cc0000";
      ctx.fill();

      // Fill level
      const minTemp = -20;
      const maxTemp = 110;
      const percent = Math.min(1, Math.max(0, (tempF - minTemp) / (maxTemp - minTemp)));
      const fillHeight = tubeHeight * percent;

      ctx.fillStyle = "#cc0000";
      ctx.fillRect(x - tubeWidth / 2 + 2, tubeTop + tubeHeight - fillHeight, tubeWidth - 4, fillHeight);

      // Draw scale
      ctx.fillStyle = "#000";
      ctx.font = "12px sans-serif";
      for (let t = minTemp; t <= maxTemp; t += 20) {
        const ty = tubeTop + tubeHeight - ((t - minTemp) / (maxTemp - minTemp)) * tubeHeight;
        ctx.fillText(t + "¬∞F", x + tubeWidth, ty + 4);
      }

      // Label current temp
      ctx.font = "bold 14px sans-serif";
      ctx.fillText("Temp: " + tempF.toFixed(1) + "¬∞F", x - 40, tubeTop + tubeHeight + bulbRadius + 20);
    }

    async function fetchAndUpdate(endpoint, chart) {
      const ts = new Date().toISOString();
      try {
        const res = await fetch(`${endpoint}?_=${ts}`, { cache: "no-store" });
        const json = await res.json();
        const data = json.data || [];

        chart.data.labels = data.map(d => d.timestamp);
        chart.data.datasets[0].data = data.map(d => d.temperature_f);
        chart.update();

        if (endpoint === "/temperature") {
          const latest = data[data.length - 1];
          if (latest && latest.temperature_f) {
            drawThermometer(latest.temperature_f);
          }
        }

        document.getElementById("status").textContent = `Last updated: ${json.queried_at}`;
      } catch (err) {
        console.error(`Error fetching ${endpoint}:`, err);
        document.getElementById("status").textContent = `Error fetching data from ${endpoint}`;
      }
    }

    function updateAll() {
      fetchAndUpdate("/temperature", chartHour);
      fetchAndUpdate("/temperature_7d", chart7d);
    }

    updateAll();
    setInterval(updateAll, 60000); // poll every 60s
  </script>
</body>
</html>